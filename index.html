<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Friendship Quiz</title>
    <style>
        :root {
            --primary-color: #3498db; --secondary-color: #2ecc71; --light-bg: #f0f4f8;
            --dark-text: #2c3e50; --white-color: #ffffff; --danger-color: #e74c3c;
            --border-color: #dfe6e9; --gold-color: #f1c40f; --ai-purple: #9b59b6;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--light-bg); color: var(--dark-text); margin: 0; padding: 20px;
            display: flex; justify-content: center; align-items: center; min-height: 100vh; box-sizing: border-box;
        }
        .container {
            background-color: var(--white-color); padding: 25px; border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1); width: 100%; max-width: 500px;
            text-align: center; box-sizing: border-box;
        }
        h1, h2, h3 { color: var(--primary-color); }
        h1 { font-size: 1.8em; margin-bottom: 20px; }
        h2 { font-size: 1.4em; margin-bottom: 25px; }
        h3 { font-size: 1.2em; margin-top: 30px; margin-bottom: 15px; color: var(--dark-text); }
        .input-field {
            width: calc(100% - 20px); padding: 12px 10px; font-size: 1em;
            border: 2px solid var(--border-color); border-radius: 8px; margin-bottom: 20px;
            transition: border-color 0.3s;
        }
        .input-field:focus { outline: none; border-color: var(--primary-color); }
        .btn {
            background-color: var(--primary-color); color: var(--white-color); border: none;
            padding: 15px 25px; font-size: 1.1em; font-weight: bold; border-radius: 8px;
            cursor: pointer; width: 100%; transition: background-color 0.3s; margin-top: 10px;
        }
        .btn:disabled { background-color: #bdc3c7; cursor: not-allowed; }
        .btn:hover:not(:disabled) { background-color: #2980b9; }
        .btn-share { background-color: var(--secondary-color); }
        .btn-share:hover:not(:disabled) { background-color: #27ae60; }
        .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }
        .btn-ai {
            background-color: var(--ai-purple);
            border-color: var(--ai-purple);
            color: white;
        }
        .btn-ai:hover:not(:disabled) { background-color: #8e44ad; }
        .btn-secondary:hover:not(:disabled) { background-color: #eaf5fc; }

        #quiz-page { text-align: left; }
        .progress-container { margin-bottom: 20px; }
        .progress-bar { width: 100%; background-color: var(--border-color); border-radius: 5px; height: 10px; }
        .progress-bar-inner { height: 100%; width: 0%; background-color: var(--primary-color); border-radius: 5px; transition: width 0.4s ease-in-out; }
        #progress-text { text-align: center; margin-top: 5px; font-weight: bold; color: var(--primary-color); }
        #question-container p { font-weight: bold; font-size: 1.2em; margin-bottom: 20px; text-align: center; }
        .options-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .option-card {
            background-color: var(--white-color); border-radius: 10px; cursor: pointer;
            border: 2px solid var(--border-color); transition: all 0.3s; overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .option-card:hover { transform: translateY(-5px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .option-card img { width: 100%; height: 120px; object-fit: cover; display: block; background-color: #eee; }
        .option-card span { display: block; padding: 15px 10px; font-weight: bold; text-align: center; }
        #share-link-container {
            margin-top: 20px; padding: 15px; background-color: #f8f9f9; border-radius: 8px;
            word-wrap: break-word; font-family: 'Courier New', Courier, monospace; color: var(--primary-color); font-weight: bold;
        }
        #results-container ul { list-style-type: none; padding: 0; text-align: left; }
        #results-container li { background-color: #f8f9f9; padding: 15px; margin-bottom: 10px; border-radius: 8px; border-left: 5px solid; }
        .correct { border-left-color: var(--secondary-color) !important; }
        .wrong { border-left-color: var(--danger-color) !important; }
        .leaderboard-list { list-style-type: none; padding: 0; }
        .leaderboard-list li {
            background: #fdfaf2; border: 1px solid #fdeec9; border-radius: 8px;
            padding: 10px 15px; margin-bottom: 8px; font-weight: bold;
            display: flex; justify-content: space-between; align-items: center;
        }
        .leaderboard-list li:first-child { background-color: var(--gold-color); color: var(--white-color); border-color: #d4a20b; }
        .hidden { display: none; }
        .loader {
            border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid var(--primary-color);
            width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .modal {
            position: fixed; z-index: 100; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            display: flex; align-items: center; justify-content: center;
        }
        .modal-content {
            background-color: #fefefe; margin: auto; padding: 20px;
            border: 1px solid #888; width: 90%; max-width: 500px;
            border-radius: 10px; position: relative;
        }
        .close-btn {
            color: #aaa; float: right; font-size: 28px; font-weight: bold;
            position: absolute; top: 10px; right: 20px;
        }
        .close-btn:hover, .close-btn:focus { color: black; text-decoration: none; cursor: pointer; }
        #ai-analysis-box {
            background-color: #f5f0f7; border: 2px solid var(--ai-purple); border-radius: 8px;
            padding: 15px; margin-top: 20px; text-align: left;
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="name-page">
            <h1>Friendship Quiz Challenge</h1>
            <p>Enter your name to create your own quiz!</p>
            <input type="text" id="name-input" class="input-field" placeholder="Enter Your Name">
            <button id="start-btn" class="btn">Create Standard Quiz</button>
            <button id="ai-generate-btn" class="btn btn-ai">‚ú® Generate AI Questions</button>
        </div>
        
        <div id="friend-name-page" class="hidden">
            <h2 id="friend-prompt-heading"></h2>
            <p>Enter your name to start the quiz!</p>
            <input type="text" id="friend-name-input" class="input-field" placeholder="Enter Your Name">
            <button id="start-friend-quiz-btn" class="btn">Take the Quiz!</button>
            <button id="view-leaderboard-btn" class="btn btn-secondary">View Leaderboard</button>
        </div>

        <div id="quiz-page" class="hidden">
            <div class="progress-container">
                <div id="progress-text"></div>
                <div class="progress-bar"><div class="progress-bar-inner"></div></div>
            </div>
            <div id="question-container"><div class="loader"></div></div>
        </div>
        
        <div id="share-page" class="hidden">
             <h2 id="share-heading"></h2>
             <p>Share this link with your friends to test them!</p>
             <div id="share-link-container"></div>
             <a id="whatsapp-share-btn" class="btn btn-share" href="#" target="_blank">üöÄ Share on WhatsApp</a>
        </div>

        <div id="results-page" class="hidden">
            <h2 id="results-heading"></h2>
            <p id="score"></p>
            <div id="results-container"></div>
            <button id="ai-analysis-btn" class="btn btn-ai hidden">‚ú® Get Friendship Analysis</button>
            <div id="ai-analysis-box" class="hidden"></div>
            
            <div id="leaderboard-section" class="hidden">
                <h3>üèÜ Leaderboard</h3>
                <ul id="leaderboard" class="leaderboard-list"></ul>
                <div id="leaderboard-loader" class="loader hidden"></div>
            </div>
            
            <hr style="margin: 25px 0; border: 1px solid #eee;">
            <p>Create your own quiz and challenge your friends!</p>
            <button class="btn" onclick="window.location.href=window.location.pathname">Create Your Own Quiz!</button>
        </div>
    </div>

    <div id="leaderboard-modal" class="modal hidden">
        <div class="modal-content">
            <span id="close-modal-btn" class="close-btn">&times;</span>
            <h3>üèÜ Leaderboard</h3>
            <ul id="modal-leaderboard-list" class="leaderboard-list"></ul>
            <div id="modal-leaderboard-loader" class="loader hidden"></div>
        </div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
      import { getFirestore, collection, doc, getDoc, addDoc, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAoh37dJCcFjw9Lce8xKvHBpKm7TqYep2M",
        authDomain: "aidata-1d74f.firebaseapp.com",
        projectId: "aidata-1d74f",
        storageBucket: "aidata-1d74f.appspot.com",
        messagingSenderId: "12946555542",
        appId: "1:12946555542:web:a733c78857d9da5633b8b7"
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      document.addEventListener('DOMContentLoaded', () => {
            const namePage = document.getElementById('name-page');
            const friendNamePage = document.getElementById('friend-name-page');
            const quizPage = document.getElementById('quiz-page');
            const sharePage = document.getElementById('share-page');
            const resultsPage = document.getElementById('results-page');
            
            const nameInput = document.getElementById('name-input');
            const friendNameInput = document.getElementById('friend-name-input');
            const startBtn = document.getElementById('start-btn');
            const aiGenerateBtn = document.getElementById('ai-generate-btn');
            const startFriendQuizBtn = document.getElementById('start-friend-quiz-btn');
            
            const viewLeaderboardBtn = document.getElementById('view-leaderboard-btn');
            const leaderboardModal = document.getElementById('leaderboard-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const aiAnalysisBtn = document.getElementById('ai-analysis-btn');
            const aiAnalysisBox = document.getElementById('ai-analysis-box');

            const defaultQuestions = [
                { q: (name) => `What is ${name}'s favorite color?`, options: [ { text: 'Red', image: 'https://i.postimg.cc/P5B29s4x/red.png' }, { text: 'Blue', image: 'https://i.postimg.cc/C1QCSkG1/blue.png' }, { text: 'White', image: 'https://i.postimg.cc/d1yY2W9L/white.jpg' }, { text: 'Black', image: 'https://i.postimg.cc/tJ019Rk7/black.jpg' } ] },
                { q: (name) => `What is ${name}'s favorite season?`, options: [ { text: 'Summer', image: 'https://i.postimg.cc/7LQKd437/images.jpg' }, { text: 'Winter', image: 'https://i.postimg.cc/gj34x6fq/images-1.jpg' }, { text: 'Monsoon', image: 'https://i.postimg.cc/Qt9frzmz/images-2.jpg' }, { text: 'Spring', image: 'https://i.postimg.cc/1RFvCLfn/images-3.jpg' } ] },
                { q: (name) => `What is ${name}'s favorite snack?`, options: [ { text: 'Cake', image: 'https://i.postimg.cc/6qFz3fjQ/images-5.jpg' }, { text: 'Samosa', image: 'https://i.postimg.cc/GpjMQY2M/images-4.jpg' }, { text: 'Golgappe', image: 'https://i.postimg.cc/440WBXfT/images-6.jpg' }, { text: 'Pakode', image: 'https://i.postimg.cc/DzHyk953/images-7.jpg' } ] },
                { q: (name) => `What is ${name}'s Hobby?`, options: [ { text: 'Cricket', image: 'https://i.postimg.cc/YqkvcWqN/images-10.jpg' }, { text: 'Mobile', image: 'https://i.postimg.cc/vZZDTwnc/images-11.jpg' }, { text: 'Reading', image: 'https://i.postimg.cc/T1jhLRQW/images-8.jpg' }, { text: 'Gaming', image: 'https://i.postimg.cc/xTRc91cw/images-9.jpg' } ] }
            ];
            
            let currentQuestionIndex, userAnswers, quizMode, userName, friendName, quizData;
            let currentQuizId = null;
            let questions = [];

            const params = new URLSearchParams(window.location.search);
            const quizIdFromUrl = params.get('quizId');

            if (quizIdFromUrl) {
                currentQuizId = quizIdFromUrl;
                loadQuizForFriend(currentQuizId);
            }

            async function loadQuizForFriend(quizId) {
                const docRef = doc(db, "quizzes", quizId);
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    quizData = docSnap.data();
                    userName = quizData.creatorName;
                    questions = quizData.questions; // Already in standardized format
                    quizMode = 'friend';
                    document.getElementById('friend-prompt-heading').innerText = `You've been challenged by ${userName}!`;
                    namePage.classList.add('hidden');
                    friendNamePage.classList.remove('hidden');
                } else {
                    alert("Quiz not found! It may have been deleted.");
                    window.location.href = window.location.pathname;
                }
            }

            startBtn.addEventListener('click', () => {
                userName = nameInput.value.trim();
                if (userName) {
                    // Standardize default questions
                    questions = defaultQuestions.map(q => ({
                        question: q.q(userName),
                        options: q.options
                    }));
                    quizMode = 'creator';
                    namePage.classList.add('hidden');
                    startQuiz();
                } else { alert('Please enter your name!'); }
            });
            
            aiGenerateBtn.addEventListener('click', async () => {
                userName = nameInput.value.trim();
                if (!userName) {
                    alert('Please enter your name first!');
                    return;
                }
                const theme = prompt("Enter a theme for your quiz (e.g., 'my favorite movies', 'my personality'):");
                if (!theme) return;
                
                aiGenerateBtn.disabled = true;
                aiGenerateBtn.innerText = "Generating...";

                try {
                    const generatedQuestions = await generateAiQuestions(theme, userName);
                    // Standardize AI questions
                    questions = generatedQuestions.map(q => ({
                        question: q.question,
                        options: q.options.map(opt => ({ text: opt, image: `https://placehold.co/150x150/cccccc/000000?text=${encodeURIComponent(opt)}` }))
                    }));
                    quizMode = 'creator';
                    namePage.classList.add('hidden');
                    startQuiz();
                } catch (error) {
                    console.error("Error generating AI questions:", error);
                    alert("Sorry, couldn't generate AI questions. Please try again.");
                } finally {
                    aiGenerateBtn.disabled = false;
                    aiGenerateBtn.innerText = "‚ú® Generate AI Questions";
                }
            });

            startFriendQuizBtn.addEventListener('click', () => {
                friendName = friendNameInput.value.trim();
                if(friendName) {
                    friendNamePage.classList.add('hidden');
                    startQuiz();
                } else { alert('Please enter your name!'); }
            });

            viewLeaderboardBtn.addEventListener('click', () => {
                leaderboardModal.classList.remove('hidden');
                displayLeaderboard('modal-leaderboard-list', 'modal-leaderboard-loader');
            });
            closeModalBtn.addEventListener('click', () => leaderboardModal.classList.add('hidden'));
            window.addEventListener('click', (event) => {
                if (event.target == leaderboardModal) {
                    leaderboardModal.classList.add('hidden');
                }
            });
            
            aiAnalysisBtn.addEventListener('click', getAiAnalysis);

            function startQuiz() {
                currentQuestionIndex = 0;
                userAnswers = [];
                quizPage.classList.remove('hidden');
                displayCurrentQuestion();
            }

            function displayCurrentQuestion() {
                if (currentQuestionIndex >= questions.length) {
                    finishQuiz();
                    return;
                }
                const progress = ((currentQuestionIndex) / questions.length) * 100;
                document.querySelector('.progress-bar-inner').style.width = `${progress}%`;
                document.getElementById('progress-text').innerText = `Question ${currentQuestionIndex + 1} of ${questions.length}`;
                const questionData = questions[currentQuestionIndex];
                const questionContainer = document.getElementById('question-container');
                const qText = questionData.question; // Always a string now
                let optionsHTML = `<div class="options-grid">`;
                questionData.options.forEach((opt, i) => {
                    optionsHTML += `<div class="option-card" data-index="${i}"><img src="${opt.image}" alt="${opt.text}" onerror="this.onerror=null;this.src='https://placehold.co/150x150/cccccc/000000?text=Image';"><span>${opt.text}</span></div>`;
                });
                optionsHTML += '</div>';
                questionContainer.innerHTML = `<p>${qText}</p>${optionsHTML}`;
                document.querySelectorAll('.option-card').forEach(c => c.addEventListener('click', handleOptionSelect));
            }

            function handleOptionSelect(event) {
                userAnswers.push(event.currentTarget.dataset.index);
                currentQuestionIndex++;
                setTimeout(displayCurrentQuestion, 200);
            }

            function finishQuiz() {
                quizPage.classList.add('hidden');
                quizMode === 'creator' ? finishCreatorQuiz() : finishFriendQuiz();
            }
            
            async function finishCreatorQuiz() {
                const shareButton = document.getElementById('whatsapp-share-btn');
                shareButton.disabled = true;
                document.getElementById('share-heading').innerText = `Generating your quiz...`;
                sharePage.classList.remove('hidden');
                
                const answersString = userAnswers.join('');
                try {
                    const docRef = await addDoc(collection(db, "quizzes"), {
                        creatorName: userName,
                        answers: answersString,
                        questions: questions, // Already in standardized format
                        createdAt: new Date()
                    });
                    currentQuizId = docRef.id;
                    
                    document.getElementById('share-heading').innerText = `${userName}, Your Quiz is Ready!`;
                    const link = `${window.location.origin}${window.location.pathname}?quizId=${currentQuizId}`;
                    document.getElementById('share-link-container').innerText = link;
                    const whatsappMsg = encodeURIComponent(`${userName} has challenged you to a friendship quiz! ü§î See if you really know them. Click the link: ${link}`);
                    shareButton.href = `https://api.whatsapp.com/send?text=${whatsappMsg}`;
                    shareButton.disabled = false;

                } catch (e) {
                    console.error("Error adding document: ", e);
                    alert("Could not create quiz. Please check your connection and try again.");
                }
            }

            async function finishFriendQuiz() {
                let score = 0;
                let resultsHTML = '<ul>';
                const correctAnswers = quizData.answers;
                questions.forEach((q, i) => {
                    const isCorrect = userAnswers[i] === correctAnswers[i];
                    if (isCorrect) score++;
                    resultsHTML += `<li class="${isCorrect ? 'correct' : 'wrong'}"><p>${q.question}</p><p>You guessed: <b>${q.options[userAnswers[i]].text}</b> ${isCorrect ? '‚úî' : `‚úñ (Correct: <b>${q.options[correctAnswers[i]].text}</b>)`}</p></li>`;
                });
                resultsHTML += '</ul>';
                
                document.getElementById('results-container').innerHTML = resultsHTML;
                document.getElementById('results-heading').innerText = `Here's your result, ${friendName}!`;
                document.getElementById('score').innerHTML = `You scored <b>${score} out of ${questions.length}</b>.`;
                resultsPage.classList.remove('hidden');
                aiAnalysisBtn.classList.remove('hidden');
                
                try {
                    await addDoc(collection(db, "quizzes", currentQuizId, "leaderboard"), {
                        name: friendName,
                        score: score,
                        createdAt: new Date()
                    });
                } catch (e) {
                    console.error("Error adding to leaderboard: ", e);
                }

                document.getElementById('leaderboard-section').classList.remove('hidden');
                displayLeaderboard('leaderboard', 'leaderboard-loader');
            }

            async function displayLeaderboard(listId, loaderId) {
                const loader = document.getElementById(loaderId);
                const leaderboardList = document.getElementById(listId);
                
                loader.classList.remove('hidden');
                leaderboardList.innerHTML = '';

                const q = query(
                    collection(db, "quizzes", currentQuizId, "leaderboard"), 
                    orderBy("score", "desc"), 
                    orderBy("createdAt", "asc")
                );
                
                try {
                    const querySnapshot = await getDocs(q);
                    const attendees = [];
                    querySnapshot.forEach((doc) => {
                        attendees.push(doc.data());
                    });

                    const totalQuestions = quizData.questions.length;
                    
                    if (attendees.length > 0) {
                        leaderboardList.innerHTML = attendees.map(p => `<li><span>${p.name}</span><span>${p.score}/${totalQuestions}</span></li>`).join('');
                    } else {
                        leaderboardList.innerHTML = '<li>No one has taken this quiz yet. Be the first!</li>';
                    }
                } catch (e) {
                    console.error("Error fetching leaderboard: ", e);
                    leaderboardList.innerHTML = '<li>Could not load leaderboard.</li>';
                } finally {
                     loader.classList.add('hidden');
                }
            }
            
            async function generateAiQuestions(theme, name) {
                const apiKey = ""; 
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                
                const prompt = `Generate 4 multiple-choice quiz questions for a friendship quiz about a person named ${name}. The theme is "${theme}". The questions should be phrased as if asking a friend, like "What is ${name}'s favorite...". Each question must have exactly 4 options. One of the options should be a plausible "correct" answer.`;

                const payload = {
                    contents: [{ parts: [{ text: prompt }] }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "OBJECT",
                            properties: {
                                "questions": {
                                    type: "ARRAY",
                                    items: {
                                        type: "OBJECT",
                                        properties: {
                                            "question": { "type": "STRING" },
                                            "options": { "type": "ARRAY", "items": { "type": "STRING" } }
                                        },
                                        required: ["question", "options"]
                                    }
                                }
                            },
                             required: ["questions"]
                        }
                    }
                };

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                const result = await response.json();
                const jsonText = result.candidates[0].content.parts[0].text;
                return JSON.parse(jsonText).questions;
            }
            
            async function getAiAnalysis() {
                aiAnalysisBtn.disabled = true;
                aiAnalysisBtn.innerText = "Analyzing...";
                aiAnalysisBox.classList.remove('hidden');
                aiAnalysisBox.innerHTML = '<div class="loader"></div>';

                const score = document.getElementById('score').innerText;
                const resultsText = Array.from(document.querySelectorAll('#results-container li')).map(li => li.innerText).join('\n');

                const prompt = `Act as a fun and friendly "Friendship Guru". A person named ${friendName} just took a friendship quiz about their friend, ${userName}.
                Their result was: "${score}".
                Here are the detailed results (question, their guess, and correct answer if wrong):
                ${resultsText}

                Based on this, write a short, playful, and encouraging analysis (2-3 sentences) of their friendship. Be positive and fun!`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API call failed with status: ${response.status}`);
                    const result = await response.json();
                    const analysisText = result.candidates[0].content.parts[0].text;
                    aiAnalysisBox.innerHTML = analysisText;
                } catch (error) {
                    console.error("Error getting AI analysis:", error);
                    aiAnalysisBox.innerHTML = "Sorry, couldn't get the friendship analysis right now.";
                } finally {
                     aiAnalysisBtn.classList.add('hidden');
                }
            }

      });
    </script>
</body>
</html>
